# Документация API

## 1. Получение токена авторизации
**Описание:** 

Авторизация пользователя с помощью OAuth2 для создания задач и получения доступа только к результатам выполнения своих задач.

Ввод логина и пароля, хеширование пароля и сравнение с паролем в БД. Авторизация при корректных данных.

**Метод:** ```POST```

**Путь:** ```/oauth/login```

**Query-параметры:**

**Accept:** ```application/x-www-form-urlencoded (OAuth2PasswordRequestForm)```

**Content-type:** ```application/json```

**Тело запроса:**
```json
{
  "grant_type": "password",
  "username": "first",
  "password": "111",
  "scope": "",
  "client_id": "",
  "client_secret": ""
}
```

**Коды ответов:**

```200 (ОК)``` - успешное создание задачи

```422 (Validation Error)``` - пользователь ввел неверные логин или пароль

**Тела ответов:**

При коде ответа 200 (OK):
```json
{
  "access_token": "***",
  "token_type": "Bearer"
}
```

При коде ответа 422 (Validation Error):
```json
{
  "detail": "Incorrect username or password"
}
```

## 2. Cоздание задачи
**Описание:** 
Создание задачи для модели нейросети. Возвращает айди задачи, которая будет выполнена моделями.

Параметр *detection_model_id* отвечает за выбор модели детекции примитивов.

Параметр *classification_model_id* отвечает за выбор модели классификации сцены.


**Метод:** ```POST```

**Путь:** ```api/tasks```

**Query-параметры:** 

detection_model_id=1 (integer)

classification_model_id=3 (integer)

**Accept:** ```image/jpeg```

**Content-type:** ```application/json```

**Заголовки:** 
```json
{
    "Authorization": "Bearer ***"
}
```

**Тело запроса:** 

```изображение```

**Коды ответов:**

```200 (ОК)``` - успешное создание задачи

```401 (Unauthorized)``` - пользователь не авторизован и не может создать задачу

```400 (Bad Request)``` - если идентификатор модели в параметре (detection_model) был указан неправильно

**Тела ответов:**

При коде ответа 200 (OK):

```json
{
    "id": 1
}
```

При коде ответа 401 (Unauthorized):

```json
{
    "detail": "Not authenticated"
}
```

При коде ответа 400 (Bad Request):
```json
{
    "detail": "Model id was not correct. Choose from (id, name, type) [(1, 'YOLO', 'detection_model'), (2, 'SSD', 'detection_model'), (1, 'model_v1', 'classification_model')]."
}
```

## 3. Получение списка задач
**Описание:**

Пользователь запрашивает список созданных им задач для просмотра их статусов (в очереди, выполняется, выполнен) и времени создания.

**Метод:** ```GET```

**Путь:** ```api/tasks```

**Query-параметры:** \-

**Content-type:** ```application/json```

**Заголовки:** 
```json
{
    "Authorization": "Bearer ***"
}
```

**Коды ответов:**

```200 (ОК)``` - успешный запрос списка задач пользователя

```401 (Unauthorized)``` - пользователь не авторизован и не может запросить список задач

**Тела ответов:**

При коде ответа 200 (OK):

```json
{
  "tasks": 
      [
        {
          "id": 1,
          "status": "queued",
          "created_at": "2012-04-23T18:25:43.511Z",
          "input_path": "img_1.jpeg"
        },
        {
          "id": 2,
          "status": "in progress",
          "created_at": "2012-04-23T18:25:43.511Z",
          "input_path": "img_2.jpeg"
        },
        {
          "id": 3,
          "status": "done",
          "created_at": "2012-04-23T18:25:43.511Z",
          "input_path": "img_3.jpeg"
        }
      ]
  
}
```

При коде ответа 401 (Unauthorized):

```json
{
    "detail": "Not authenticated"
}
```

## 4. Получение статуса задачи
**Описание:** 

Получение по айди статуса задачи (в очереди, выполняется, выполнена). 

(Пользователь может запрашивать просмотр только своих задач. Запрос производится в контексте задач пользователя, т.е при запросе не существующей в БД задачи и при запросе задачи не принадлежащей пользователю будет возвращен ответ "задача не найдена".)

**Метод:** ```GET```

**Путь:** ```api/tasks/{task_id:integer}/status```

**Query-параметры:** \-

**Content-type:** ```application/json```

**Заголовки:** 
```json
{
    "Authorization": "Bearer ***"
}
```

**Коды ответов:**

```200 (ОК)``` - успешный запрос списка задач пользователя

```401 (Unauthorized)``` - пользователь не авторизован и не может запросить список задач

```404 (Not Found)``` - если задача с указанным идентификатором отсутствует в списке задач авторизованного пользователя

**Тела ответов:**

При коде ответа 200 (OK):

```json
{
    "id": 1,
    "status": "queued"
}
```
или 
```json
{
    "id": 2,
    "status": "queued"
}
```
или 
```json
{
    "id": 3,
    "status": "in progress"
}
```

При коде ответа 401 (Unauthorized):

```json
{
    "detail": "Not authenticated"
}
```

При коде ответа 404 (Not Found):
```json
{
    "detail": "Task with id {id} does not exist."
}
```

## 5. Получение входных данных задачи
**Описание:** 

Запрос входного изображения определенной задачи пользователя.

(Пользователь может запрашивать просмотр входных данных только своих задач. Запрос производится в контексте задач пользователя, т.е при запросе не существующей в БД задачи и при запросе задачи не принадлежащей пользователю будет возвращен ответ "задача не найдена".)

**Метод:** ```GET```

**Путь:** ```api/tasks/{task_id:integer}/input```

**Query-параметры:** \-

**Заголовки:** 
```json
{
    "Authorization": "Bearer ***"
}
```

**Коды ответов:**

```200 (ОК)``` - успешный запрос входных данных задачи пользователя

```401 (Unauthorized)``` - пользователь не авторизован и не может запросить входные данные задачи

```404 (Not Found)``` - если задача с указанным идентификатором отсутствует в списке задач авторизованного пользователя

**Тела ответов:**

При коде ответа 200 (OK):

```(FileResponse) jpeg изображение```

При коде ответа 401 (Unauthorized):

```json
{
    "detail": "Not authenticated"
}
```

При коде ответа 404 (Not Found):
```json
{
    "detail": "Task with id {id} does not exist."
}
```

## 6. Получение результата задачи (предсказание)
**Описание:** 

При запросе результата задачи (предсказания) возвращается объект с айди задачи, статусом и результатом выполнения при наличии (status="done").

Если задача запланирована (status="queued") или выполняется (status="in progress") - результат задачи будет None.

(Пользователь может запрашивать просмотр только своих задач. Запрос производится в контексте задач пользователя, т.е при запросе не существующей в БД задачи и при запросе задачи не принадлежащей пользователю будет возвращен ответ "задача не найдена".)

**Метод:** ```GET```

**Путь:** ```tasks/{task_id:integer}/result```

**Query-параметры:** \-

**Content-type:** ```application/json```

**Заголовки:** 
```json
{
    "Authorization": "Bearer ***"
}
```

**Коды ответов:**

```200 (ОК)``` - успешный запрос результата задачи пользователя

```401 (Unauthorized)``` - пользователь не авторизован и не может запросить результат задачи

```404 (Not Found)``` - если задача с указанным идентификатором отсутствует в списке задач авторизованного пользователя

**Тела ответов:**

При коде ответа 200 (OK):

```jsonc
{
    "id": 1,
    "status": "done",
    "result": {
      "image_class": "office",
      "primitives": [
        {
          "primitive_class": "sphere",
          "x": 0.26, // normalized [0, 1]
          "y": 0.30, // normalized [0, 1]
          "width": 0.1,  // normalized [0, 1]
          "height": 0.2, // normalized [0, 1]
          "rotation": 0.8 // normalized [0, 1]
          "probability": 0.26 // [0, 1]
        },
        {
          "primitive_class": "cube",
          "x": 0.26, // normalized [0, 1]
          "y": 0.30, // normalized [0, 1]
          "width": 0.1,  // normalized [0, 1]
          "height": 0.2, // normalized [0, 1]
          "rotation": 0.8 // normalized [0, 1]
          "probability": 0.76 // [0, 1]
        }
      ]
    }
}
```
или
```json
{
    "id": 2,
    "status": "queued",
    "result": "None"
}
```
или

```json
{
    "id": 3,
    "status": "in progress",
    "result": "None"
}
```

При коде ответа 401 (Unauthorized):

```json
{
    "detail": "Not authenticated"
}
```

При коде ответа 404 (Not Found):
```json
{
    "detail": "Task with id {id} does not exist."
}
```

## 7. Получение списка моделей
**Описание:** 

Запрос списка доступных моделей детекции и классификации, идентификаторов для их использования.

**Метод:** ```GET```

**Путь:** ```api/models```

**Query-параметры:** \-

**Заголовки:** 
```json
{
    "Authorization": "Bearer ***"
}
```

**Content-type:** ```application/json```

```200 (ОК)``` - успешный запрос списка моделей детекции

```401 (Unauthorized)``` - пользователь не авторизован и не может запросить список моделей

**Тела ответов:**

При коде ответа 200 (OK):

```json
{
    "detection_models": [
      {
        "model_name": "YOLO",
        "model_id": 1
      },
      {
        "model_name": "SSD",
        "model_id": 2
      }
    ],
    "classification_models": [
      {
        "model_name": "model_v1",
        "model_id": 3
      }
    ]
}
```

При коде ответа 401 (Unauthorized):

```json
{
    "detail": "Not authenticated"
}
```

## 8. Удаление задачи 
**Описание:** 

Поиск задачи по айди и ее удаление, чтобы освободить место в БД системы или отменить еще не выполненную задачу.

Возвращает айди удаленной задачи.

(Пользователь может запрашивать удаление только своих задач. Запрос производится в контексте задач пользователя, т.е при запросе не существующей в БД задачи и при запросе задачи не принадлежащей пользователю будет возвращен ответ "задача не найдена".)

**Метод:** ```DELETE```

**Путь:** ```api/tasks/{task_id:integer}```

**Query-параметры:** \-

**Заголовки:** 
```json
{
    "Authorization": "Bearer ***"
}
```

**Content-type:** ```application/json```

```200 (ОК)``` - успешный запрос списка моделей детекции

```401 (Unauthorized)``` - пользователь не авторизован и не может запросить список моделей

```404 (Not Found)``` - если задача с указанным идентификатором отсутствует в списке задач авторизованного пользователя

**Тела ответов:**

При коде ответа 200 (OK):

```json
{
    "id": 1
}
```

При коде ответа 401 (Unauthorized):

```json
{
    "detail": "Not authenticated"
}
```

При коде ответа 404 (Not Found):
```json
{
    "detail": "Task with id {id} does not exist."
}
```
